<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xadrez - Stockfish 16</title>
    <meta name="description" content="Jogue xadrez contra o Stockfish 16 online gratuitamente." />

    <link rel="icon" type="image/svg" href="img/icons/favicon.svg" />
    <link rel="stylesheet" id="chessboard-css" href="css/chessboard.css" />
    <link rel="stylesheet" href="css/board.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .game-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
        }
        
        .board-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        #board {
            border: 2px solid #444;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            width: min(80vw, 80vh, 640px);
            height: min(80vw, 80vh, 640px);
            max-width: 640px;
            max-height: 640px;
        }
        
        /* Estilo para as pe√ßas do xadrez ficarem grandes */
        #board img {
            width: 80px !important;
            height: 80px !important;
            max-width: 80px !important;
            max-height: 80px !important;
        }
        
        /* Estilo para as casas do tabuleiro */
        #board .square {
            width: 80px !important;
            height: 80px !important;
        }
        
        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .settings-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            min-width: 300px;
            backdrop-filter: blur(20px);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .settings-panel.open {
            transform: translateX(0);
            opacity: 1;
        }
        
        .settings-panel h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }
        
        .setting-group {
            margin-bottom: 20px;
        }
        
        .setting-group label {
            color: #ccc;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .difficulty-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .difficulty-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .difficulty-btn.selected {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
            backdrop-filter: blur(10px);
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.5);
        }
        
        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }
        
        .btn-success {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.5);
        }
        
        .btn-success:hover {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .side-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .side-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
        }
        
        .side-btn.selected {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }
        
        .status-display {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .promotion {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(20px);
            z-index: 2000;
        }
        
        .promotion.hidden {
            display: none;
        }
        
        .promotion-options {
            display: flex;
            gap: 15px;
        }
        
        .promotion-piece {
            width: 60px;
            height: 60px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: all 0.3s ease;
        }
        
        .promotion-piece:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .settings-panel {
                right: 10px;
                left: 10px;
                min-width: auto;
            }
            
            .difficulty-selector {
                grid-template-columns: repeat(4, 1fr);
            }
            
            #board {
                width: 95vw;
                height: 95vw;
                max-width: 95vw;
                max-height: 95vw;
            }
            
            .game-container {
                gap: 15px;
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            #board {
                width: 98vw;
                height: 98vw;
                max-width: 98vw;
                max-height: 98vw;
            }
        }
    </style>
</head>

<body>
    <div class="game-container">
        <!-- Bot√£o de configura√ß√µes -->
        <button id="settings-btn" class="settings-btn" title="Configura√ß√µes">‚öôÔ∏è</button>
        
        <!-- Painel de configura√ß√µes -->
        <div id="settings-panel" class="settings-panel">
            <button class="close-btn" id="close-settings">√ó</button>
            <h3>‚öôÔ∏è Configura√ß√µes</h3>
            
            <!-- Informa√ß√£o do lado -->
            <div class="setting-group">
                <label>Configura√ß√£o do jogo:</label>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="color: #4CAF50; font-weight: bold; margin-bottom: 5px;">‚ö™ Voc√™: Brancas</div>
                    <div style="color: #f44336; font-weight: bold;">‚ö´ Stockfish: Pretas</div>
                </div>
            </div>
            
            <!-- Dificuldade da IA -->
            <div class="setting-group">
                <label>Dificuldade da IA:</label>
                <div class="difficulty-selector">
                    <div class="difficulty-btn" data-level="1">1</div>
                    <div class="difficulty-btn" data-level="2">2</div>
                    <div class="difficulty-btn" data-level="3">3</div>
                    <div class="difficulty-btn" data-level="4">4</div>
                    <div class="difficulty-btn" data-level="5">5</div>
                    <div class="difficulty-btn" data-level="6">6</div>
                    <div class="difficulty-btn" data-level="7">7</div>
                    <div class="difficulty-btn" data-level="8">8</div>
                    <div class="difficulty-btn" data-level="9">9</div>
                    <div class="difficulty-btn selected" data-level="10">10</div>
                    <div class="difficulty-btn" data-level="11">11</div>
                    <div class="difficulty-btn" data-level="12">12</div>
                    <div class="difficulty-btn" data-level="13">13</div>
                    <div class="difficulty-btn" data-level="14">14</div>
                    <div class="difficulty-btn" data-level="15">15</div>
                    <div class="difficulty-btn" data-level="16">16</div>
                    <div class="difficulty-btn" data-level="17">17</div>
                    <div class="difficulty-btn" data-level="18">18</div>
                    <div class="difficulty-btn" data-level="19">19</div>
                    <div class="difficulty-btn" data-level="20">20</div>
                </div>
                <p style="color: #999; font-size: 12px; margin-top: 5px;">
                    N√≠vel atual: <span id="current-difficulty">10</span> (1 = F√°cil, 20 = Muito Dif√≠cil)
                </p>
            </div>
            
            <!-- Controles do jogo -->
            <div class="setting-group">
                <label>Controles:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <button id="btn-new-game" class="btn btn-success">üÜï Novo Jogo</button>
                    <button id="btn-resign" class="btn btn-danger">üè≥Ô∏è Desistir</button>
                    <button id="btn-analyze" class="btn">üìä An√°lise</button>
                    <button id="btn-show-hint" class="btn">üí° Dica</button>
                    <button id="btn-take-back" class="btn disabled">‚Ü∂ Desfazer</button>
                    <button id="btn-flip-board" class="btn">üîÑ Virar</button>
                </div>
            </div>
        </div>
        
        <!-- Container do tabuleiro -->
        <div class="board-container">
            <!-- Popup para promo√ß√£o de pe√£o -->
            <div id="game-promotion" class="promotion hidden">
                <div class="promotion-options">
                    <span figure="q" class="promotion-piece">‚ôï</span>
                    <span figure="r" class="promotion-piece">‚ôñ</span>
                    <span figure="b" class="promotion-piece">‚ôó</span>
                    <span figure="n" class="promotion-piece">‚ôò</span>
                </div>
            </div>
            
            <!-- Tabuleiro de xadrez -->
            <div id="board" class="board"></div>
        </div>
        
        <!-- Status do jogo -->
        <div id="game-status" class="status-display">
            Clique em "Novo Jogo" para come√ßar
        </div>
    </div>

    <!-- Scripts JavaScript -->
    <script src="js/libs/jquery-3.6.0.min.js"></script>
    <script src="js/libs/chess.min.js"></script>
    <script src="js/libs/chessboard.min.js"></script>
    
    <script>
        // Vari√°veis globais
        let settingsOpen = false;
        
        // Inicializa√ß√£o do jogo
        $(document).ready(function() {
            console.log('üéÆ Inicializando jogo de xadrez minimalista...');
            
            // Configurar bot√£o de configura√ß√µes
            $('#settings-btn').click(function() {
                toggleSettings();
            });
            
            $('#close-settings').click(function() {
                closeSettings();
            });
            
            // Fechar configura√ß√µes ao clicar fora
            $(document).click(function(e) {
                if (!$(e.target).closest('#settings-panel, #settings-btn').length) {
                    closeSettings();
                }
            });
            
            // Configurar sele√ß√£o de dificuldade
            $('.difficulty-btn').click(function() {
                $('.difficulty-btn').removeClass('selected');
                $(this).addClass('selected');
                const level = $(this).data('level');
                $('#current-difficulty').text(level);
                updateEngineSkill(level);
                updateStatus(`Dificuldade alterada para n√≠vel ${level}`);
            });
            
            // Configura√ß√£o fixa: jogador sempre branco, Stockfish sempre preto
            playerSide = 'w';
            opponentSide = 'b';
            
            // Configurar bot√£o de novo jogo
            $('#btn-new-game').click(function() {
                startNewGame();
                closeSettings();
            });
            
            // Configurar bot√£o de desistir
            $('#btn-resign').click(function() {
                if (confirm('Tem certeza que deseja desistir?')) {
                    resignGame();
                    closeSettings();
                }
            });
            
            // Configurar bot√£o de an√°lise
            $('#btn-analyze').click(function() {
                if (!$(this).hasClass('disabled')) {
                    analyzePosition();
                }
            });
            
            // Configurar bot√£o de dica
            $('#btn-show-hint').click(function() {
                if (!$(this).hasClass('disabled')) {
                    showHint();
                }
            });
            
            // Configurar bot√£o de desfazer
            $('#btn-take-back').click(function() {
                if (!$(this).hasClass('disabled')) {
                    takeBackMove();
                }
            });
            
            // Configurar bot√£o de virar tabuleiro
            $('#btn-flip-board').click(function() {
                if (typeof board !== 'undefined' && board.flip) {
                    board.flip();
                    updateStatus('Tabuleiro virado');
                }
            });
            
            // Inicializar o tabuleiro e Stockfish
            setTimeout(function() {
                console.log('üéÆ Inicializando jogo...');
                initStockfish();
                initializeBoard();
                
                // Verificar se o tabuleiro foi criado
                setTimeout(function() {
                    if (typeof board === 'undefined' || !board) {
                        console.log('‚ö†Ô∏è Tentando reinicializar tabuleiro...');
                        initializeBoard();
                    }
                }, 2000);
            }, 1000);
        });
        
        // Fun√ß√£o para alternar painel de configura√ß√µes
        function toggleSettings() {
            settingsOpen = !settingsOpen;
            if (settingsOpen) {
                $('#settings-panel').addClass('open');
            } else {
                $('#settings-panel').removeClass('open');
            }
        }
        
        // Fun√ß√£o para fechar configura√ß√µes
        function closeSettings() {
            settingsOpen = false;
            $('#settings-panel').removeClass('open');
        }
        
        // Fun√ß√£o para atualizar status
        function updateStatus(message) {
            $('#game-status').text(message);
            setTimeout(function() {
                if (typeof game !== 'undefined' && game.turn()) {
                    const turn = game.turn() === 'w' ? 'Brancas' : 'Pretas';
                    $('#game-status').text(`Vez das ${turn}`);
                }
            }, 2000);
        }
        
        // Fun√ß√£o para atualizar n√≠vel da IA
        function updateEngineSkill(level) {
            engineSkill = level;
            if (typeof stockfish !== 'undefined') {
                stockfish.postMessage('setoption name skill level value ' + level);
                console.log('üéØ N√≠vel da IA alterado para: ' + level);
            }
        }
        
        // Fun√ß√£o para iniciar novo jogo
        function startNewGame() {
            console.log('üÜï Iniciando novo jogo...');
            updateStatus('Novo jogo iniciado! Voc√™ joga com as Brancas.');
            
            // For√ßar jogador a ser sempre branco
            playerSide = 'w';
            opponentSide = 'b';
            
            // Resetar vari√°veis do jogo
            gameStarted = true;
            gameEnd = false;
            
            // Habilitar controles
            $('#btn-take-back').addClass('disabled');
            $('#btn-analyze').removeClass('disabled');
            $('#btn-show-hint').removeClass('disabled');
            
            // Inicializar tabuleiro se necess√°rio
            if (typeof board === 'undefined') {
                initializeBoard();
        } else {
                board.position('start');
                board.orientation('white');
                if (typeof game !== 'undefined') {
                    game = new Chess();
                }
            }
            
            // Desbloquear tabuleiro para o jogador come√ßar
            $('#board').removeClass('locked');
            updateStatus('Sua vez! Fa√ßa o primeiro movimento (Brancas)');
        }
        
        // Fun√ß√£o para desistir do jogo
        function resignGame() {
            console.log('üè≥Ô∏è Jogador desistiu do jogo');
            gameEnd = true;
            updateStatus('Voc√™ desistiu do jogo!');
            
            // Desabilitar controles
            $('#btn-analyze').addClass('disabled');
            $('#btn-show-hint').addClass('disabled');
            $('#btn-take-back').addClass('disabled');
        }
        
        // Fun√ß√£o para analisar posi√ß√£o
        function analyzePosition() {
            if (typeof stockfish !== 'undefined' && typeof game !== 'undefined') {
                console.log('üìä Analisando posi√ß√£o...');
                $('#btn-analyze').addClass('disabled');
                updateStatus('Analisando posi√ß√£o...');
                
                stateAnalyze = 'grep';
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth ' + staticSkill);
            }
        }
        
        // Fun√ß√£o para mostrar dica
        function showHint() {
            if (typeof stockfish !== 'undefined' && typeof game !== 'undefined') {
                console.log('üí° Mostrando dica...');
                $('#btn-show-hint').addClass('disabled');
                updateStatus('Calculando melhor movimento...');
                
                stateHint = 'grep';
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth ' + engineSkill);
            }
        }
        
        // Fun√ß√£o para desfazer movimento
        function takeBackMove() {
            if (typeof game !== 'undefined' && game.history().length > 0) {
                console.log('‚Ü∂ Desfazendo movimento...');
                game.undo();
                if (typeof board !== 'undefined') {
                    board.position(game.fen());
                }
                listMoves();
                updateStatus('Movimento desfeito!');
            }
        }
        
        // Fun√ß√£o para inicializar tabuleiro manualmente
        function initializeBoard() {
            try {
                console.log('üîß Inicializando tabuleiro...');
                console.log('ChessBoard dispon√≠vel:', typeof ChessBoard !== 'undefined');
                console.log('Chess dispon√≠vel:', typeof Chess !== 'undefined');
                
                // Garantir que o jogador √© sempre branco
                playerSide = 'w';
                opponentSide = 'b';
                
                // Inicializar jogo
                game = new Chess();
                console.log('‚úÖ Jogo Chess inicializado');
                
                // Verificar se o elemento board existe
                const boardElement = document.getElementById('board');
                console.log('Board element:', boardElement);
                
                if (boardElement && typeof ChessBoard !== 'undefined') {
                    // Inicializar tabuleiro
                    board = ChessBoard('board', {
                        draggable: true,
                        position: 'start',
                        orientation: 'white',
                        onDragStart: onDragStart,
                        onDrop: onDrop,
                        onSnapEnd: onSnapEnd,
                        pieceTheme: 'img/pieces/{piece}.svg',
                        showNotation: false,
                        sparePieces: false
                    });
                    
                    console.log('‚úÖ Tabuleiro inicializado com sucesso!');
                    console.log('Board object:', board);
                    
                    updateStatus('Tabuleiro pronto! Clique em "Novo Jogo" para come√ßar');
                } else {
                    console.error('‚ùå Elemento board n√£o encontrado ou ChessBoard n√£o dispon√≠vel');
                    updateStatus('Erro: Elemento board n√£o encontrado');
                }
            } catch (error) {
                console.error('‚ùå Erro ao inicializar tabuleiro:', error);
                updateStatus('Erro ao inicializar tabuleiro: ' + error.message);
            }
        }
        
        // Inicializar Stockfish
        let stockfish;
        let gameStarted = false;
        let gameEnd = false;
        let engineSkill = 10;
        
        function initStockfish() {
            try {
                stockfish = new Worker('js/engine/stockfish-nnue-16-single.js');
                
                stockfish.onmessage = function(event) {
                    console.log('Stockfish:', event.data);
                    
                    const eventStr = event.data;
                    
                    // Processar movimento do Stockfish
                    if (eventStr.indexOf('bestmove') !== -1) {
                        const match = eventStr.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbk])?/);
                        
                        if (match) {
                            console.log('Stockfish move:', match[1], 'to', match[2]);
                            
                            const move = game.move({
                                from: match[1],
                                to: match[2],
                                promotion: match[3] || 'q'
                            });
                            
                            if (move) {
                                board.position(game.fen());
                                updateStatus('Sua vez! (Brancas)');
                                $('#board').removeClass('locked');
                                
                                // Verificar fim de jogo
                                if (game.isGameOver()) {
                                    if (game.isCheckmate()) {
                                        updateStatus('Xeque-mate! Voc√™ venceu!');
                                    } else if (game.isDraw()) {
                                        updateStatus('Empate!');
                                    }
                                    gameEnd = true;
                                }
                            }
                        }
                    }
                };
                
                // Configurar Stockfish
                stockfish.postMessage('uci');
                stockfish.postMessage('setoption name skill level value ' + engineSkill);
                stockfish.postMessage('isready');
                
                console.log('‚úÖ Stockfish inicializado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Stockfish:', error);
            }
        }
        
        // Fun√ß√µes de callback do tabuleiro
        function onDragStart(source, piece, position, orientation) {
            if (gameEnd) return false;
            if (game.turn() !== playerSide) return false;
            if (piece.search(/^b/) !== -1 && game.turn() === 'w') return false;
            if (piece.search(/^w/) !== -1 && game.turn() === 'b') return false;
        }
        
        function onDrop(source, target) {
            try {
                const move = game.move({
                    from: source,
                    to: target,
                    promotion: 'q'
                });
                
                if (move === null) return 'snapback';
                
                board.position(game.fen());
                
                // Atualizar status
                updateStatus('Stockfish est√° pensando... (Pretas)');
                $('#board').addClass('locked');
                
                // Verificar fim de jogo
                if (game.isGameOver()) {
                    if (game.isCheckmate()) {
                        updateStatus('Xeque-mate! Stockfish venceu!');
                    } else if (game.isDraw()) {
                        updateStatus('Empate!');
                    }
                    gameEnd = true;
                    return true;
                }
                
                // Fazer Stockfish jogar
                if (game.turn() === 'b' && !gameEnd) {
                    setTimeout(() => {
                        stockfish.postMessage('position fen ' + game.fen());
                        stockfish.postMessage('go depth ' + engineSkill);
                    }, 500);
                }
                
                return true;
            } catch (error) {
                console.error('Erro no movimento:', error);
                return 'snapback';
            }
        }
        
        function onSnapEnd() {
            board.position(game.fen());
        }
    </script>
</body>
</html>
