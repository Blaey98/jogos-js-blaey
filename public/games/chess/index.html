<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xadrez - Stockfish 16</title>
    <meta name="description" content="Jogue xadrez contra o Stockfish 16 online gratuitamente." />

    <link rel="icon" type="image/svg" href="img/icons/favicon.svg" />
    <link rel="stylesheet" id="chessboard-css" href="css/chessboard.css" />
    <link rel="stylesheet" href="css/board.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .game-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
        }
        
        .board-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        #board {
            border: 2px solid #444;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            width: min(80vw, 80vh, 640px);
            height: min(80vw, 80vh, 640px);
            max-width: 640px;
            max-height: 640px;
        }
        
        /* Estilo para as peças do xadrez ficarem grandes */
        #board img {
            width: 80px !important;
            height: 80px !important;
            max-width: 80px !important;
            max-height: 80px !important;
        }
        
        /* Estilo para as casas do tabuleiro */
        #board .square {
            width: 80px !important;
            height: 80px !important;
        }
        
        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .settings-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            min-width: 300px;
            backdrop-filter: blur(20px);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .settings-panel.open {
            transform: translateX(0);
            opacity: 1;
        }
        
        .settings-panel h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }
        
        .setting-group {
            margin-bottom: 20px;
        }
        
        .setting-group label {
            color: #ccc;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .difficulty-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .difficulty-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .difficulty-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .difficulty-btn.selected {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 5px;
            backdrop-filter: blur(10px);
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.5);
        }
        
        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }
        
        .btn-success {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.5);
        }
        
        .btn-success:hover {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .side-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .side-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
        }
        
        .side-btn.selected {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }
        
        .status-display {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Estilos para área de logs */
        .logs-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 400px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(20px);
            z-index: 1001;
            font-family: 'Courier New', monospace;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .logs-header h4 {
            color: white;
            margin: 0;
            font-size: 14px;
        }
        
        .btn-small {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .btn-small:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .logs-content {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .log-entry {
            color: #00ff00;
            font-size: 12px;
            margin-bottom: 5px;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry.error {
            color: #ff4444;
        }
        
        .log-entry.warning {
            color: #ffaa00;
        }
        
        .log-entry.info {
            color: #4488ff;
        }
        
        .logs-content.collapsed {
            display: none;
        }
        
        /* Estilos para indicador de nível do Stockfish */
        .stockfish-level-indicator {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 10px 20px;
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }
        
        .level-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .level-label {
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        .level-value {
            color: #4CAF50;
            font-size: 16px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }
        
        .level-controls {
            display: flex;
            gap: 5px;
        }
        
        .level-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .level-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .level-btn:active {
            transform: scale(0.95);
        }
        
        .level-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .promotion {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(20px);
            z-index: 2000;
        }
        
        .promotion.hidden {
            display: none;
        }
        
        .promotion-options {
            display: flex;
            gap: 15px;
        }
        
        .promotion-piece {
            width: 60px;
            height: 60px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: all 0.3s ease;
        }
        
        .promotion-piece:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .settings-panel {
                right: 10px;
                left: 10px;
                min-width: auto;
            }
            
            .difficulty-selector {
                grid-template-columns: repeat(4, 1fr);
            }
            
            #board {
                width: 95vw;
                height: 95vw;
                max-width: 95vw;
                max-height: 95vw;
            }
            
            .game-container {
                gap: 15px;
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            #board {
                width: 98vw;
                height: 98vw;
                max-width: 98vw;
                max-height: 98vw;
            }
        }
    </style>
</head>

<body>
    <div class="game-container">
        <!-- Botão de configurações -->
        <button id="settings-btn" class="settings-btn" title="Configurações">⚙️</button>
        
        <!-- Painel de configurações -->
        <div id="settings-panel" class="settings-panel">
            <button class="close-btn" id="close-settings">×</button>
            <h3>⚙️ Configurações</h3>
            
            <!-- Informação do lado -->
            <div class="setting-group">
                <label>Configuração do jogo:</label>
                <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 8px; text-align: center;">
                    <div style="color: #4CAF50; font-weight: bold; margin-bottom: 5px;">⚪ Você: Brancas</div>
                    <div style="color: #f44336; font-weight: bold;">⚫ Stockfish: Pretas</div>
                </div>
            </div>
            
            <!-- Dificuldade da IA -->
            <div class="setting-group">
                <label>Dificuldade da IA:</label>
                <div class="difficulty-selector">
                    <div class="difficulty-btn" data-level="1">1</div>
                    <div class="difficulty-btn" data-level="2">2</div>
                    <div class="difficulty-btn" data-level="3">3</div>
                    <div class="difficulty-btn" data-level="4">4</div>
                    <div class="difficulty-btn" data-level="5">5</div>
                    <div class="difficulty-btn" data-level="6">6</div>
                    <div class="difficulty-btn" data-level="7">7</div>
                    <div class="difficulty-btn" data-level="8">8</div>
                    <div class="difficulty-btn" data-level="9">9</div>
                    <div class="difficulty-btn selected" data-level="10">10</div>
                    <div class="difficulty-btn" data-level="11">11</div>
                    <div class="difficulty-btn" data-level="12">12</div>
                    <div class="difficulty-btn" data-level="13">13</div>
                    <div class="difficulty-btn" data-level="14">14</div>
                    <div class="difficulty-btn" data-level="15">15</div>
                    <div class="difficulty-btn" data-level="16">16</div>
                    <div class="difficulty-btn" data-level="17">17</div>
                    <div class="difficulty-btn" data-level="18">18</div>
                    <div class="difficulty-btn" data-level="19">19</div>
                    <div class="difficulty-btn" data-level="20">20</div>
                </div>
                <p style="color: #999; font-size: 12px; margin-top: 5px;">
                    Nível atual: <span id="current-difficulty">10</span> (1 = Fácil, 20 = Muito Difícil)
                </p>
            </div>
            
            <!-- Controles do jogo -->
            <div class="setting-group">
                <label>Controles:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <button id="btn-new-game" class="btn btn-success">🆕 Novo Jogo</button>
                    <button id="btn-resign" class="btn btn-danger">🏳️ Desistir</button>
                    <button id="btn-analyze" class="btn">📊 Análise</button>
                    <button id="btn-show-hint" class="btn">💡 Dica</button>
                    <button id="btn-take-back" class="btn disabled">↶ Desfazer</button>
                    <button id="btn-flip-board" class="btn">🔄 Virar</button>
                </div>
            </div>
            
            <!-- Botões de Debug -->
            <div class="setting-group">
                <label>Debug:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <button id="btn-test-stockfish" class="btn">🧪 Testar Stockfish</button>
                    <button id="btn-force-move" class="btn">🔄 Forçar IA</button>
                    <button id="btn-diagnose" class="btn">🔍 Diagnosticar</button>
                </div>
            </div>
        </div>
        
        <!-- Container do tabuleiro -->
        <div class="board-container">
            <!-- Indicador de nível do Stockfish -->
            <div class="stockfish-level-indicator">
                <div class="level-display">
                    <span class="level-label">🤖 Stockfish Nível:</span>
                    <span id="current-level-display" class="level-value">10</span>
                </div>
                <div class="level-controls">
                    <button id="level-down" class="level-btn">-</button>
                    <button id="level-up" class="level-btn">+</button>
                </div>
            </div>
            
            <!-- Popup para promoção de peão -->
            <div id="game-promotion" class="promotion hidden">
                <div class="promotion-options">
                    <span figure="q" class="promotion-piece">♕</span>
                    <span figure="r" class="promotion-piece">♖</span>
                    <span figure="b" class="promotion-piece">♗</span>
                    <span figure="n" class="promotion-piece">♘</span>
                </div>
            </div>
            
            <!-- Tabuleiro de xadrez -->
            <div id="board" class="board"></div>
        </div>
        
        <!-- Status do jogo -->
        <div id="game-status" class="status-display">
            Clique em "Novo Jogo" para começar
        </div>
        
        <!-- Área de Logs -->
        <div id="logs-panel" class="logs-panel">
            <div class="logs-header">
                <h4>📋 Logs do Sistema</h4>
                <button id="clear-logs" class="btn-small">🗑️ Limpar</button>
                <button id="toggle-logs" class="btn-small">📖 Mostrar/Ocultar</button>
            </div>
            <div id="logs-content" class="logs-content">
                <div class="log-entry">Sistema iniciado...</div>
            </div>
        </div>
    </div>

    <!-- Scripts JavaScript -->
    <script src="js/libs/jquery-3.6.0.min.js"></script>
    <script src="js/libs/chess.min.js"></script>
    <script src="js/libs/chessboard.min.js"></script>
    
    <script>
        // Variáveis globais
        let settingsOpen = false;
        let logsVisible = true;
        
        // Funções de log
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const logsContent = document.getElementById('logs-content');
            logsContent.appendChild(logEntry);
            logsContent.scrollTop = logsContent.scrollHeight;
            
            // Também logar no console
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLogs() {
            const logsContent = document.getElementById('logs-content');
            logsContent.innerHTML = '<div class="log-entry">Logs limpos...</div>';
        }
        
        function toggleLogs() {
            logsVisible = !logsVisible;
            const logsContent = document.getElementById('logs-content');
            if (logsVisible) {
                logsContent.classList.remove('collapsed');
            } else {
                logsContent.classList.add('collapsed');
            }
        }
        
        // Inicialização do jogo
        $(document).ready(function() {
            addLog('🎮 Inicializando jogo de xadrez minimalista...', 'info');
            
            // Configurar botão de configurações
            $('#settings-btn').click(function() {
                toggleSettings();
            });
            
            $('#close-settings').click(function() {
                closeSettings();
            });
            
            // Fechar configurações ao clicar fora
            $(document).click(function(e) {
                if (!$(e.target).closest('#settings-panel, #settings-btn').length) {
                    closeSettings();
                }
            });
            
            // Configurar seleção de dificuldade
            $('.difficulty-btn').click(function() {
                $('.difficulty-btn').removeClass('selected');
                $(this).addClass('selected');
                const level = $(this).data('level');
                $('#current-difficulty').text(level);
                updateEngineSkill(level);
                updateStatus(`Dificuldade alterada para nível ${level}`);
            });
            
            // Configuração fixa: jogador sempre branco, Stockfish sempre preto
            playerSide = 'w';
            opponentSide = 'b';
            
            // Configurar botão de novo jogo
            $('#btn-new-game').click(function() {
                startNewGame();
                closeSettings();
            });
            
            // Configurar botão de desistir
            $('#btn-resign').click(function() {
                if (confirm('Tem certeza que deseja desistir?')) {
                    resignGame();
                    closeSettings();
                }
            });
            
            // Configurar botão de análise
            $('#btn-analyze').click(function() {
                if (!$(this).hasClass('disabled')) {
                    analyzePosition();
                }
            });
            
            // Configurar botão de dica
            $('#btn-show-hint').click(function() {
                if (!$(this).hasClass('disabled')) {
                    showHint();
                }
            });
            
            // Configurar botão de desfazer
            $('#btn-take-back').click(function() {
                if (!$(this).hasClass('disabled')) {
                    takeBackMove();
                }
            });
            
            // Configurar botão de virar tabuleiro
            $('#btn-flip-board').click(function() {
                if (typeof board !== 'undefined' && board.flip) {
                    board.flip();
                    updateStatus('Tabuleiro virado');
                }
            });
            
            // Botões de debug
            $('#btn-test-stockfish').click(function() {
                testStockfish();
            });
            
            $('#btn-force-move').click(function() {
                forceStockfishMove();
            });
            
            $('#btn-diagnose').click(function() {
                diagnoseGame();
            });
            
            // Botões de controle de nível do Stockfish
            $('#level-up').click(function() {
                increaseLevel();
            });
            
            $('#level-down').click(function() {
                decreaseLevel();
            });
            
            // Botões de logs
            $('#clear-logs').click(function() {
                clearLogs();
            });
            
            $('#toggle-logs').click(function() {
                toggleLogs();
            });
            
            // Inicializar o tabuleiro e Stockfish
            setTimeout(function() {
                addLog('🎮 Inicializando jogo...', 'info');
                initStockfish();
                initializeBoard();
                
                // Inicializar display do nível
                updateLevelDisplay();
                
                // Verificar se o tabuleiro foi criado
                setTimeout(function() {
                    if (typeof board === 'undefined' || !board) {
                        console.log('⚠️ Tentando reinicializar tabuleiro...');
                        initializeBoard();
                    }
                }, 2000);
                
                // Verificar se o Stockfish está funcionando
                setTimeout(function() {
                    if (!stockfishReady) {
                        console.log('⚠️ Stockfish não está pronto, tentando reinicializar...');
                        initStockfish();
                    } else {
                        console.log('✅ Stockfish verificado e funcionando!');
                    }
                }, 3000);
                
                // Verificação adicional após 5 segundos
                setTimeout(function() {
                    if (!stockfishReady) {
                        console.log('❌ Stockfish ainda não está pronto após 5 segundos');
                        updateStatus('Erro: Stockfish não carregou');
                    }
                }, 5000);
            }, 1000);
        });
        
        // Função para alternar painel de configurações
        function toggleSettings() {
            settingsOpen = !settingsOpen;
            if (settingsOpen) {
                $('#settings-panel').addClass('open');
            } else {
                $('#settings-panel').removeClass('open');
            }
        }
        
        // Função para fechar configurações
        function closeSettings() {
            settingsOpen = false;
            $('#settings-panel').removeClass('open');
        }
        
        // Função para atualizar status
        function updateStatus(message) {
            $('#game-status').text(message);
            setTimeout(function() {
                if (typeof game !== 'undefined' && game.turn()) {
                    const turn = game.turn() === 'w' ? 'Brancas' : 'Pretas';
                    $('#game-status').text(`Vez das ${turn}`);
                }
            }, 2000);
        }
        
        // Função para atualizar nível da IA
        function updateEngineSkill(level) {
            engineSkill = level;
            if (stockfish && stockfishReady) {
                stockfish.postMessage('setoption name skill level value ' + level);
                addLog(`⚙️ Stockfish skill level definido para: ${level}`, 'info');
            }
        }
        
        // Função para iniciar novo jogo
        function startNewGame() {
            try {
                addLog('🆕 Iniciando novo jogo...', 'info');
                
                // Forçar jogador a ser sempre branco
                playerSide = 'w';
                opponentSide = 'b';
                
                // Resetar variáveis do jogo
                gameStarted = true;
                gameEnd = false;
                
                // Inicializar jogo
                game = new Chess();
                addLog('✅ Novo jogo Chess criado', 'info');
                
                // Inicializar tabuleiro se necessário
                if (typeof board === 'undefined') {
                    addLog('⚠️ Board não existe, inicializando...', 'warning');
                    initializeBoard();
                } else {
                    addLog('✅ Board existe, resetando posição...', 'info');
                    board.position('start');
                    board.orientation('white');
                }
                
                // Desbloquear tabuleiro para o jogador começar
                $('#board').removeClass('locked');
                
                addLog('✅ Novo jogo iniciado!', 'info');
                addLog(`Jogador: ${playerSide} (Brancas)`, 'info');
                addLog(`Stockfish: ${opponentSide} (Pretas)`, 'info');
                addLog(`Stockfish pronto: ${stockfishReady}`, 'info');
                
                updateStatus('Sua vez! Faça o primeiro movimento (Brancas)');
                closeSettings();
            } catch (error) {
                addLog(`❌ Erro ao iniciar novo jogo: ${error.message}`, 'error');
                updateStatus('Erro ao iniciar jogo');
            }
        }
        
        // Função para desistir do jogo
        function resignGame() {
            console.log('🏳️ Jogador desistiu do jogo');
            gameEnd = true;
            updateStatus('Você desistiu do jogo!');
            
            // Desabilitar controles
            $('#btn-analyze').addClass('disabled');
            $('#btn-show-hint').addClass('disabled');
            $('#btn-take-back').addClass('disabled');
        }
        
        // Função para analisar posição
        function analyzePosition() {
            if (typeof stockfish !== 'undefined' && typeof game !== 'undefined') {
                console.log('📊 Analisando posição...');
                $('#btn-analyze').addClass('disabled');
                updateStatus('Analisando posição...');
                
                stateAnalyze = 'grep';
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth ' + staticSkill);
            }
        }
        
        // Função para mostrar dica
        function showHint() {
            if (typeof stockfish !== 'undefined' && typeof game !== 'undefined') {
                console.log('💡 Mostrando dica...');
                $('#btn-show-hint').addClass('disabled');
                updateStatus('Calculando melhor movimento...');
                
                stateHint = 'grep';
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth ' + engineSkill);
            }
        }
        
        // Função para desfazer movimento
        function takeBackMove() {
            if (typeof game !== 'undefined' && game.history().length > 0) {
                console.log('↶ Desfazendo movimento...');
                game.undo();
                if (typeof board !== 'undefined') {
                    board.position(game.fen());
                }
                listMoves();
                updateStatus('Movimento desfeito!');
            }
        }
        
        // Função para inicializar tabuleiro manualmente
        function initializeBoard() {
            try {
                addLog('🔧 Inicializando tabuleiro...', 'info');
                addLog(`ChessBoard disponível: ${typeof ChessBoard !== 'undefined'}`, 'info');
                addLog(`Chess disponível: ${typeof Chess !== 'undefined'}`, 'info');
                
                // Garantir que o jogador é sempre branco
                playerSide = 'w';
                opponentSide = 'b';
                
                // Inicializar jogo
                game = new Chess();
                addLog('✅ Jogo Chess inicializado', 'info');
                
                // Verificar se o elemento board existe
                const boardElement = document.getElementById('board');
                addLog(`Board element: ${boardElement ? 'existe' : 'não existe'}`, 'info');
                
                if (boardElement && typeof ChessBoard !== 'undefined') {
                    // Inicializar tabuleiro
                    board = ChessBoard('board', {
                        draggable: true,
                        position: 'start',
                        orientation: 'white',
                        onDragStart: onDragStart,
                        onDrop: onDrop,
                        onSnapEnd: onSnapEnd,
                        pieceTheme: 'img/pieces/{piece}.svg',
                        showNotation: false,
                        sparePieces: false
                    });
                    
                    addLog('✅ Tabuleiro inicializado com sucesso!', 'info');
                    addLog(`Board object: ${board ? 'existe' : 'não existe'}`, 'info');
                    
                    updateStatus('Tabuleiro pronto! Clique em "Novo Jogo" para começar');
                } else {
                    addLog('❌ Elemento board não encontrado ou ChessBoard não disponível', 'error');
                    updateStatus('Erro: Elemento board não encontrado');
                }
            } catch (error) {
                addLog(`❌ Erro ao inicializar tabuleiro: ${error.message}`, 'error');
                updateStatus('Erro ao inicializar tabuleiro: ' + error.message);
            }
        }
        
        // Inicializar Stockfish
        let stockfish;
        let gameStarted = false;
        let gameEnd = false;
        let engineSkill = 10;
        let stockfishReady = false;
        
        function initStockfish() {
            try {
                addLog('🤖 Inicializando Stockfish...', 'info');
                
                // Verificar se já existe um worker
                if (stockfish) {
                    addLog('⚠️ Stockfish já existe, terminando worker anterior...', 'warning');
                    stockfish.terminate();
                }
                
                // Criar novo worker
                addLog('📦 Criando Worker do Stockfish...', 'info');
                stockfish = new Worker('js/engine/stockfish-nnue-16-single.js');
                
                stockfish.onmessage = function(event) {
                    addLog(`📨 Stockfish: ${event.data}`, 'info');
                    
                    const eventStr = event.data;
                    
                    // Verificar se Stockfish está pronto
                    if (eventStr.indexOf('readyok') !== -1) {
                        stockfishReady = true;
                        addLog('✅ Stockfish está pronto!', 'info');
                        updateStatus('Stockfish carregado! Clique em "Novo Jogo" para começar');
                    }
                    
                    // Verificar se UCI está ativo
                    if (eventStr.indexOf('uciok') !== -1) {
                        addLog('✅ UCI ativado!', 'info');
                    }
                    
                    // Processar movimento do Stockfish
                    if (eventStr.indexOf('bestmove') !== -1) {
                        addLog(`🎯 Stockfish respondeu: ${eventStr}`, 'info');
                        const match = eventStr.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbk])?/);
                        
                        if (match) {
                            const from = match[1];
                            const to = match[2];
                            const promotion = match[3] || 'q';
                            
                            addLog(`🎯 Stockfish move: ${from} to ${to} (promotion: ${promotion})`, 'info');
                            addLog(`🎯 Turno antes do movimento: ${game.turn()}`, 'info');
                            
                            try {
                                // Verificar se o movimento é das pretas
                                if (from && to) {
                                    addLog(`🔍 Verificando movimento: ${from} → ${to}`, 'info');
                                    
                                    const move = game.move({
                                        from: from,
                                        to: to,
                                        promotion: promotion
                                    });
                                    
                                    if (move) {
                                        addLog(`✅ Movimento do Stockfish executado: ${JSON.stringify(move)}`, 'info');
                                        addLog(`🎯 Turno após movimento: ${game.turn()}`, 'info');
                                        
                                        // Atualizar tabuleiro
                                        board.position(game.fen());
                                        
                                        // Desbloquear tabuleiro para o jogador
                                        $('#board').removeClass('locked');
                                        
                                        // Verificar fim de jogo
                                        if (game && typeof game.isGameOver === 'function' && game.isGameOver()) {
                                            if (game.isCheckmate()) {
                                                addLog('🏆 Xeque-mate! Você venceu!', 'info');
                                                updateStatus('Xeque-mate! Você venceu!');
                                            } else if (game.isDraw()) {
                                                addLog('🤝 Empate!', 'info');
                                                updateStatus('Empate!');
                                            }
                                            gameEnd = true;
                                        } else {
                                            addLog('👤 Sua vez! (Brancas)', 'info');
                                            updateStatus('Sua vez! (Brancas)');
                                        }
                                    } else {
                                        addLog('❌ Movimento inválido do Stockfish', 'error');
                                        updateStatus('Erro: Movimento inválido do Stockfish');
                                    }
                                } else {
                                    addLog('❌ Coordenadas inválidas do Stockfish', 'error');
                                }
                            } catch (error) {
                                addLog(`❌ Erro ao executar movimento do Stockfish: ${error.message}`, 'error');
                                updateStatus('Erro ao executar movimento do Stockfish');
                            }
                        } else {
                            addLog(`❌ Não foi possível parsear movimento do Stockfish: ${eventStr}`, 'error');
                        }
                    }
                };
                
                stockfish.onerror = function(error) {
                    addLog(`❌ Erro no Worker do Stockfish: ${error.message}`, 'error');
                    updateStatus('Erro no Worker do Stockfish');
                };
                
                // Configurar Stockfish com delay para garantir que está carregado
                setTimeout(() => {
                    addLog('🔧 Configurando Stockfish...', 'info');
                    stockfish.postMessage('uci');
                    
                    setTimeout(() => {
                        addLog(`⚙️ Definindo skill level: ${engineSkill}`, 'info');
                        stockfish.postMessage('setoption name skill level value ' + engineSkill);
                        stockfish.postMessage('isready');
                    }, 100);
                }, 500);
                
                addLog('✅ Stockfish Worker criado!', 'info');
            } catch (error) {
                addLog(`❌ Erro ao inicializar Stockfish: ${error.message}`, 'error');
                updateStatus('Erro ao carregar Stockfish: ' + error.message);
            }
        }
        
        // Funções de callback do tabuleiro
        function onDragStart(source, piece, position, orientation) {
            if (gameEnd) return false;
            if (game.turn() !== playerSide) return false;
            if (piece.search(/^b/) !== -1 && game.turn() === 'w') return false;
            if (piece.search(/^w/) !== -1 && game.turn() === 'b') return false;
        }
        
        function onDrop(source, target) {
            try {
                addLog(`🎯 onDrop chamado: ${source} → ${target}`, 'info');
                addLog(`🎯 Game object: ${game ? 'existe' : 'não existe'}`, 'info');
                
                if (!game) {
                    addLog('❌ Game object não existe!', 'error');
                    return 'snapback';
                }
                
                // Verificar se é a vez do jogador
                if (game.turn() !== playerSide) {
                    addLog(`❌ Não é a vez do jogador (turno: ${game.turn()}, player: ${playerSide})`, 'warning');
                    return 'snapback';
                }
                
                const move = game.move({
                    from: source,
                    to: target,
                    promotion: 'q'
                });
                
                if (move === null) {
                    addLog('❌ Movimento inválido', 'error');
                    return 'snapback';
                }
                
                addLog(`✅ Movimento do jogador: ${JSON.stringify(move)}`, 'info');
                board.position(game.fen());
                
                // Verificar fim de jogo
                if (game && typeof game.isGameOver === 'function' && game.isGameOver()) {
                    if (game.isCheckmate()) {
                        addLog('🏆 Xeque-mate! Você venceu!', 'info');
                        updateStatus('Xeque-mate! Você venceu!');
                    } else if (game.isDraw()) {
                        addLog('🤝 Empate!', 'info');
                        updateStatus('Empate!');
                    }
                    gameEnd = true;
                    return true;
                }
                
                // Fazer Stockfish jogar automaticamente
                addLog(`🎯 Verificando turno: ${game.turn()} (${game.turn() === 'w' ? 'Brancas' : 'Pretas'})`, 'info');
                addLog(`🎯 Stockfish pronto: ${stockfishReady}`, 'info');
                addLog(`🎯 Jogo terminado: ${gameEnd}`, 'info');
                
                if (game.turn() === 'b' && !gameEnd && stockfishReady) {
                    addLog('🤖 É a vez do Stockfish (Pretas)...', 'info');
                    updateStatus('Stockfish está pensando... (Pretas)');
                    $('#board').addClass('locked');
                    
                    const fen = game.fen();
                    addLog(`📤 Enviando FEN para Stockfish: ${fen}`, 'info');
                    addLog(`🎯 Turno atual: ${game.turn()} (Pretas)`, 'info');
                    
                    // Enviar comando para Stockfish imediatamente
                    stockfish.postMessage('position fen ' + fen);
                    stockfish.postMessage('go depth ' + engineSkill);
                } else if (!stockfishReady) {
                    addLog('⚠️ Stockfish não está pronto', 'warning');
                    updateStatus('Stockfish não está pronto');
                } else if (game.turn() === 'w') {
                    addLog('👤 Sua vez! (Brancas)', 'info');
                    updateStatus('Sua vez! (Brancas)');
                } else {
                    addLog(`⚠️ Situação inesperada - Turno: ${game.turn()}, Stockfish pronto: ${stockfishReady}`, 'warning');
                }
                
                return true;
            } catch (error) {
                console.error('❌ Erro no movimento:', error);
                return 'snapback';
            }
        }
        
        function onSnapEnd() {
            board.position(game.fen());
        }
        
        // Função para testar Stockfish
        function testStockfish() {
            addLog('🧪 Testando Stockfish...', 'info');
            addLog(`Stockfish object: ${stockfish ? 'existe' : 'não existe'}`, 'info');
            addLog(`Stockfish ready: ${stockfishReady}`, 'info');
            
            if (stockfish && stockfishReady) {
                addLog('📤 Enviando comando de teste (posição inicial)...', 'info');
                // Testar com posição inicial onde as pretas jogam
                stockfish.postMessage('position startpos moves e2e4');
                stockfish.postMessage('go depth 1');
            } else if (stockfish && !stockfishReady) {
                addLog('⚠️ Stockfish existe mas não está pronto, tentando reinicializar...', 'warning');
                initStockfish();
            } else {
                addLog('❌ Stockfish não existe, criando novo...', 'error');
                initStockfish();
            }
        }
        
        // Função para forçar Stockfish a jogar
        function forceStockfishMove() {
            if (game && game.turn() === 'b' && stockfish && stockfishReady && !gameEnd) {
                addLog('🔄 Forçando movimento do Stockfish...', 'info');
                const fen = game.fen();
                addLog(`📤 FEN atual: ${fen}`, 'info');
                stockfish.postMessage('position fen ' + fen);
                stockfish.postMessage('go depth ' + engineSkill);
            } else {
                addLog('❌ Não é possível forçar movimento do Stockfish', 'error');
                addLog(`Game turn: ${game ? game.turn() : 'undefined'}`, 'info');
                addLog(`Stockfish ready: ${stockfishReady}`, 'info');
                addLog(`Game end: ${gameEnd}`, 'info');
            }
        }
        
        // Função para diagnosticar o problema
        function diagnoseGame() {
            addLog('🔍 DIAGNÓSTICO DO JOGO:', 'info');
            addLog(`Game object: ${game ? 'existe' : 'não existe'}`, 'info');
            if (game) {
                addLog(`Turno atual: ${game.turn()} (${game.turn() === 'w' ? 'Brancas' : 'Pretas'})`, 'info');
                addLog(`FEN: ${game.fen()}`, 'info');
                addLog(`Jogo iniciado: ${gameStarted}`, 'info');
                addLog(`Jogo terminado: ${gameEnd}`, 'info');
            }
            addLog(`Player side: ${playerSide} (${playerSide === 'w' ? 'Brancas' : 'Pretas'})`, 'info');
            addLog(`Opponent side: ${opponentSide} (${opponentSide === 'w' ? 'Brancas' : 'Pretas'})`, 'info');
            addLog(`Stockfish ready: ${stockfishReady}`, 'info');
        }
        
        // Funções para controlar nível do Stockfish
        function updateLevelDisplay() {
            document.getElementById('current-level-display').textContent = engineSkill;
            addLog(`🎯 Nível do Stockfish alterado para: ${engineSkill}`, 'info');
        }
        
        function increaseLevel() {
            if (engineSkill < 20) {
                engineSkill++;
                updateLevelDisplay();
                updateEngineSkill(engineSkill);
            }
        }
        
        function decreaseLevel() {
            if (engineSkill > 1) {
                engineSkill--;
                updateLevelDisplay();
                updateEngineSkill(engineSkill);
            }
        }
        
    </script>
</body>
</html>
